#!/bin/sh


# CRONFILE FOR ARCHIVE IN DIRECTORY /usr/www/htdocs/reflectsearch

quiet=""
if [ "$1" = "-q" ] ; then
  quiet="-q"
fi

# create a file to insure that no one searches during an index
touch /usr/www/htdocs/reflectsearch/indexing-in-progress

# delete the search boxes in all current files (filelist may change)
/usr/local/www/webglimpse/addsearch /usr/www/htdocs/reflectsearch -r $quiet

# Do the retrieving
/usr/local/www/webglimpse/makenh /usr/www/htdocs/reflectsearch $quiet

# put the search box in the html files -- will check config file
#  and will not do anything if not wanted
/usr/local/www/webglimpse/addsearch /usr/www/htdocs/reflectsearch $quiet

# Do the indexing
if [ "$quiet" = "-q" ] ; then
   /bin/cat /usr/www/htdocs/reflectsearch/.wg_toindex | /usr/local/bin/glimpseindex -H /usr/www/htdocs/reflectsearch -o -t -h -X -U -f -C -F > /dev/null

else
   /bin/cat /usr/www/htdocs/reflectsearch/.wg_toindex | /usr/local/bin/glimpseindex -H /usr/www/htdocs/reflectsearch -o -t -h -X -U -f -C -F

fi

# Compress neighborhood files
if [ "$quiet" = "-q" ] ; then
  /bin/cat /usr/www/htdocs/reflectsearch/.wg_madenh | /usr/local/bin/wgconvert -H /usr/www/htdocs/reflectsearch -U -P .nh. -F -ni | grep -v "^hash_misses=0"
else
  /bin/cat /usr/www/htdocs/reflectsearch/.wg_madenh | /usr/local/bin/wgconvert -H /usr/www/htdocs/reflectsearch -U -P .nh. -F -ni
fi

# now change the directory and set the permissions
cd /usr/www/htdocs/reflectsearch
chmod a+r .glimpse_*

# remove the locking file
/bin/rm -f /usr/www/htdocs/reflectsearch/indexing-in-progress

