#!/bin/sh


# CRONFILE FOR ARCHIVE IN DIRECTORY /usr/local/apache/htdocs/gl

quiet=""
if [ "$1" = "-q" ] ; then
  quiet="-q"
fi

# create a file to insure that no one searches during an index
touch /usr/local/apache/htdocs/gl/indexing-in-progress

# delete the search boxes in all current files (filelist may change)
/usr/local/www/webglimpse/addsearch /usr/local/apache/htdocs/gl -r $quiet

# Do the retrieving
/usr/local/www/webglimpse/makenh /usr/local/apache/htdocs/gl $quiet

# put the search box in the html files -- will check config file
#  and will not do anything if not wanted
/usr/local/www/webglimpse/addsearch /usr/local/apache/htdocs/gl $quiet

# Do the indexing
if [ "$quiet" = "-q" ] ; then
   /bin/cat /usr/local/apache/htdocs/gl/.wg_toindex | /usr/local/bin/glimpseindex -H /usr/local/apache/htdocs/gl -o -t -h -X -U -f -C -F > /dev/null

else
   /bin/cat /usr/local/apache/htdocs/gl/.wg_toindex | /usr/local/bin/glimpseindex -H /usr/local/apache/htdocs/gl -o -t -h -X -U -f -C -F

fi

# Compress neighborhood files
if [ "$quiet" = "-q" ] ; then
  /bin/cat /usr/local/apache/htdocs/gl/.wg_madenh | /usr/local/bin/wgconvert -H /usr/local/apache/htdocs/gl -U -P .nh. -F -ni | grep -v "^hash_misses=0"
else
  /bin/cat /usr/local/apache/htdocs/gl/.wg_madenh | /usr/local/bin/wgconvert -H /usr/local/apache/htdocs/gl -U -P .nh. -F -ni
fi

# now change the directory and set the permissions
cd /usr/local/apache/htdocs/gl
chmod a+r .glimpse_*

# remove the locking file
/bin/rm -f /usr/local/apache/htdocs/gl/indexing-in-progress

